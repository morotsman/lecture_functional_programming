<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Demo</title>


    <!--App lib BEGIN-->
	<script type="text/javascript" src="lib/L/L.js"></script>
        <script src="https://unpkg.com/rxjs/bundles/Rx.min.js"></script>
    <!--App lib END-->

   

</head>
<body>
    
    <div>
        <button id="startGame">Start game</button>
    </div>
    
    <div>
        <input type="text" id="anagramInput"></input>
        <button id="buttonInput">Add</button>
    </div>
    
    
    </br>
    
    <div>
        <span>Anagrams</span>
        <table id="output">
            
        </table>
    </div>
    
    <div id="clock"></div>
    
    

</body>

<script>
    
    document.getElementById('anagramInput').disabled = true;
    
    /*****Start game**/
    const timeToPlay = 20;
   
    const seconds = Rx.Observable.interval(1000);
    
    const gameStarted = Rx.Observable.fromEvent(document.getElementById("startGame"), 'click');
    
    const gameTick = seconds.skipUntil(gameStarted).scan((acc,value) => {
        return acc-1;
    },timeToPlay+1);
    
    const gameCompleted = gameTick.takeWhile(x => x > -1).filter(x => x === 0).repeat();
                 
    const ongoingGame = gameTick.takeWhile(x => x > 0).repeat();
    
    gameCompleted.subscribe(x => {
        document.getElementById('startGame').disabled = false; 
        document.getElementById('anagramInput').disabled = true;
        document.getElementById("clock").innerHTML = "Game over";       
    });
    
    ongoingGame.subscribe(x => {
       document.getElementById("clock").innerHTML = x;  
    });
    
    
    gameStarted.subscribe(x => {
        document.getElementById('anagramInput').value = '';
        document.getElementById('anagramInput').disabled = false;     
        document.getElementById('startGame').disabled = true;
        removeChilds(document.getElementById("output"));
    });
    
    
    /****Anagrams****/
    const sortedString = string => string.split("").sort().join("")
    const objectValues = obj => Object.keys(obj).map(key => obj[key]);
    const removeChilds = element => {
        while (element.firstChild) {
            element.removeChild(element.firstChild);
        }
    }
    
    const buttonSource = Rx.Observable
            .fromEvent(document.getElementById("buttonInput"), 'click')
            
    const enterSource = Rx.Observable
            .fromEvent(document.getElementById("anagramInput"), 'keydown')
            .filter(key => key.code === "Enter");
    
    const source = Rx.Observable.merge(buttonSource,enterSource).map(event => document.getElementById("anagramInput").value);
    
    const anagramStreams = source.distinct().groupBy(x => sortedString(x));
                       
    anagramStreams.takeUntil(gameCompleted).repeat().subscribe(anagram => {
        const key = anagram.key;
        output.insertAdjacentHTML('beforeend', "<tr id='" + key + "'></tr>"); 
      
        anagram.subscribe(word => {
            console.log("key: " + key);
            const anagramOutput = document.getElementById(key);
            const currentValues = anagramOutput.innerHTML.split(",").filter(x => x !== "")
            anagramOutput.innerHTML = currentValues.concat([word]).join(",");
            document.getElementById('anagramInput').value = '';
        })
    });
    
    
</script>
</html>